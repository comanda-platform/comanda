@using Comanda.Client.Kitchen.Infrastructure.Services
@using Comanda.Client.Kitchen.Infrastructure.Localization

@{
    var activeBatch = GetActiveBatch();
    var hasActiveBatch = activeBatch != null;
}

<MudCard Elevation="2" Class="production-item-card">
    <MudCardContent Class="pa-3">
        <MudStack Spacing="2">
            @* Header row: Name and Status *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                    @(MenuItem.OverriddenName ?? MenuItem.ProductName)
                </MudText>
                <AvailabilityBadge Level="@Availability.Level" Remaining="@Availability.Remaining" />
            </MudStack>
            
            @* Stats row: Produced | Committed | Remaining *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="stats-row">
                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h6" Color="Color.Primary">@Availability.Produced</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Produced"]</MudText>
                </MudStack>
                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h6" Color="Color.Warning">@Availability.Committed</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Committed"]</MudText>
                </MudStack>
                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h6" Color="@GetRemainingColor()">@Availability.Remaining</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Remaining"]</MudText>
                </MudStack>
            </MudStack>
            
            @* Progress bar *@
            <AvailabilityProgressBar Produced="@Availability.Produced" Available="@Availability.Remaining" />
            
            @* Cooking timer if active *@
            @if (hasActiveBatch && activeBatch!.StartedAt.HasValue)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1" Class="cooking-timer">
                    <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Small" Color="Color.Warning" />
                    <MudText Typo="Typo.body2" Color="Color.Warning">@L["CookingFor"]</MudText>
                    <ElapsedTimer StartTime="@activeBatch.StartedAt.Value" />
                </MudStack>
            }
            
            @* Completed batches summary *@
            @if (CompletedBatches.Any())
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="batches-summary">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @CompletedBatches.Count() @L["BatchesCompleted"]
                    </MudText>
                </MudStack>
            }
        </MudStack>
    </MudCardContent>
    
    <MudCardActions Class="pa-2 pt-0">
        <MudStack Row="true" Spacing="1" Style="width: 100%;" AlignItems="AlignItems.Center">
            @if (hasActiveBatch)
            {
                @* Mark Ready button when cooking *@
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="@(() => OnMarkReady.InvokeAsync(activeBatch!.BatchPublicId))"
                           Size="Size.Small"
                           Style="flex: 1;">
                    @L["EnterYield"]
                </MudButton>
            }
            else
            {
                @* Start Cooking button *@
                <MudButton Variant="Variant.Filled"
                           Color="Color.Warning"
                           StartIcon="@Icons.Material.Filled.LocalFireDepartment"
                           OnClick="@(() => OnStartCooking.InvokeAsync(MenuItem.ProductPublicId))"
                           Size="Size.Small"
                           Style="flex: 1;">
                    @L["StartCooking"]
                </MudButton>
            }
            
            @* Recipe button *@
            <MudIconButton Icon="@Icons.Material.Filled.MenuBook"
                           Color="Color.Primary"
                           OnClick="@(() => OnViewRecipe.InvokeAsync(MenuItem.ProductPublicId))"
                           Title="@L["ViewRecipe"]"
                           Size="Size.Small" />
        </MudStack>
    </MudCardActions>
</MudCard>

<style>
    .production-item-card {
        border-left: 4px solid var(--mud-palette-primary);
    }
    
    .production-item-card .stats-row {
        padding: 8px 0;
    }
    
    .production-item-card .cooking-timer {
        background-color: rgba(255, 152, 0, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    .production-item-card .batches-summary {
        padding: 2px 0;
    }
</style>

@code {
    [Parameter, EditorRequired] public DailyMenuItemResponse MenuItem { get; set; } = default!;
    [Parameter, EditorRequired] public AvailabilityInfo Availability { get; set; } = default!;
    [Parameter] public IEnumerable<BatchState> Batches { get; set; } = [];
    
    [Parameter] public EventCallback<string> OnStartCooking { get; set; }
    [Parameter] public EventCallback<string> OnMarkReady { get; set; }
    [Parameter] public EventCallback<string> OnViewRecipe { get; set; }
    
    [Inject] private LocalizationService L { get; set; } = default!;
    
    private BatchState? GetActiveBatch() => Batches.FirstOrDefault(b => b.Status == CookingStatus.InProgress);
    private IEnumerable<BatchState> CompletedBatches => Batches.Where(b => b.Status == CookingStatus.Completed);
    
    private Color GetRemainingColor()
    {
        return Availability.Level switch
        {
            AvailabilityLevel.Good => Color.Success,
            AvailabilityLevel.Low => Color.Warning,
            AvailabilityLevel.Critical => Color.Error,
            AvailabilityLevel.SoldOut => Color.Dark,
            _ => Color.Default
        };
    }
}







